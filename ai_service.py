from google import genai
import os
import logging

logger = logging.getLogger(__name__)

# –ü–æ–ø—ã—Ç–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∫–ª–∏–µ–Ω—Ç.
# –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–ª—É—á–∞–π, –µ—Å–ª–∏ GOOGLE_API_KEY –µ—â–µ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.
try:
    client = genai.Client(api_key=os.getenv("GOOGLE_API_KEY"))
except Exception:
    client = None

# –°–ø–∏—Å–æ–∫ –º–æ–¥–µ–ª–µ–π –¥–ª—è –ø–æ–ø—ã—Ç–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –≤ –ø–æ—Ä—è–¥–∫–µ —É–±—ã–≤–∞–Ω–∏—è –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞
PREFERRED_MODELS = [
    "gemini-2.5-pro",
    "gemini-2.5-flash",
    "gemini-pro",
]

def get_proposal_text(prompt: str) -> str:
    """
    –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ö–ü, –∏—Å–ø–æ–ª—å–∑—É—è –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤—É—é —Ü–µ–ø–æ—á–∫—É –º–æ–¥–µ–ª–µ–π Gemini.
    """
    if not client:
        logger.error("‚ùå –ö–ª–∏–µ–Ω—Ç Gemini –Ω–µ –±—ã–ª —Å–∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä–æ–≤–∞–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ GOOGLE_API_KEY.")
        # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ—Å–º—ã—Å–ª–µ–Ω–Ω—ã–π —á–µ—Ä–Ω–æ–≤–∏–∫, –µ—Å–ª–∏ AI –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
        return (
            "–ö–æ–º–º–µ—Ä—á–µ—Å–∫–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ (–ß–µ—Ä–Ω–æ–≤–∏–∫)\n\n"
            f"–ó–∞–ø—Ä–æ—Å: {prompt}\n\n"
            "–°–µ—Ä–≤–∏—Å AI –Ω–µ —Å–∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä–æ–≤–∞–Ω. –ú–µ–Ω–µ–¥–∂–µ—Ä —Å–∫–æ—Ä–æ —Å–≤—è–∂–µ—Ç—Å—è —Å –≤–∞–º–∏."
        )

    last_error = None
    
    full_prompt = (
        f"–¢—ã ‚Äî –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –±–∏–∑–Ω–µ—Å-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç. –°–æ—Å—Ç–∞–≤—å –∫–æ–º–º–µ—Ä—á–µ—Å–∫–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ "
        f"–Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö: {prompt}. "
        f"–°—Ç—Ä—É–∫—Ç—É—Ä–∞: –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ, –ü–æ–Ω–∏–º–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏, –ü—Ä–µ–¥–ª–∞–≥–∞–µ–º–æ–µ —Ä–µ—à–µ–Ω–∏–µ, –°—Ä–æ–∫–∏ –∏ —Å—Ç–æ–∏–º–æ—Å—Ç—å (–ø—Ä–∏–º–µ—Ä–Ω—ã–µ), –ü—Ä–∏–∑—ã–≤ –∫ –¥–µ–π—Å—Ç–≤–∏—é. "
        f"–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π Markdown (–∂–∏—Ä–Ω—ã–π, –∫—É—Ä—Å–∏–≤, –∑–∞–≥–æ–ª–æ–≤–∫–∏ #), "
        f"–ø–∏—à–∏ –ø—Ä–æ—Å—Ç—ã–º —Ç–µ–∫—Å—Ç–æ–º, —Ä–∞–∑–¥–µ–ª—è—è —Å–º—ã—Å–ª–æ–≤—ã–µ –±–ª–æ–∫–∏ –ø—É—Å—Ç—ã–º–∏ —Å—Ç—Ä–æ–∫–∞–º–∏."
    )

    for model_name in PREFERRED_MODELS:
        try:
            logger.info(f"ü§ñ –ü—Ä–æ–±—É—é –º–æ–¥–µ–ª—å: {model_name}...")
            # –ü—Ä—è–º–æ–π –≤—ã–∑–æ–≤ generate_content —Å —É–∫–∞–∑–∞–Ω–∏–µ–º –∏–º–µ–Ω–∏ –º–æ–¥–µ–ª–∏
            response = client.models.generate_content(
                model=f"models/{model_name}", # –í –Ω–æ–≤–æ–º SDK –ø—Ä–∏–Ω—è—Ç–æ —É–∫–∞–∑—ã–≤–∞—Ç—å models/
                contents=full_prompt,
            )

            text = getattr(response, "text", None)
            if text:
                logger.info(f"‚úÖ –ú–æ–¥–µ–ª—å {model_name} —É—Å–ø–µ—à–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–ª–∞ –æ—Ç–≤–µ—Ç.")
                return text.strip()
            else:
                logger.warning(f"‚ö†Ô∏è –ú–æ–¥–µ–ª—å {model_name} –≤–µ—Ä–Ω—É–ª–∞ –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç.")
                last_error = ValueError(f"Empty response from model {model_name}")
                continue

        except Exception as e:
            last_error = e
            logger.warning(f"‚ö†Ô∏è –ú–æ–¥–µ–ª—å {model_name} –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –∏–ª–∏ –≤—ã–∑–≤–∞–ª–∞ –æ—à–∏–±–∫—É.")
            continue

    # –≠—Ç–æ—Ç –±–ª–æ–∫ –≤—ã–ø–æ–ª–Ω–∏—Ç—Å—è, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–∏ –æ–¥–Ω–∞ –º–æ–¥–µ–ª—å –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–∞
    logger.error("‚ùå –ù–∏ –æ–¥–Ω–∞ –∏–∑ –ø—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π Gemini –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–∞.", exc_info=last_error)
    return (
        "–ö–æ–º–º–µ—Ä—á–µ—Å–∫–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ (–ß–µ—Ä–Ω–æ–≤–∏–∫)\n\n"
        f"–ó–∞–ø—Ä–æ—Å: {prompt}\n\n"
        "–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, —Å–µ—Ä–≤–∏—Å –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. "
        "–ú–µ–Ω–µ–¥–∂–µ—Ä —Å–≤—è–∂–µ—Ç—Å—è —Å –≤–∞–º–∏ –ª–∏—á–Ω–æ."
    )