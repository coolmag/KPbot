import openai
import os

# Инициализируем клиент один раз. Он автоматически подхватит ключ из .env
client = openai.OpenAI()

def get_proposal_text(prompt):
    """
    Отправляет промпт в OpenAI API и возвращает сгенерированный текст
    коммерческого предложения.
    """
    try:
        # Промпт для AI, который будет формировать КП
        # Мы "зашиваем" инструкцию для AI прямо здесь
        system_prompt = """
Ты — AI-ассистент, который помогает фрилансерам составлять коммерческие предложения (КП).
Твоя задача — на основе краткого описания проекта от пользователя сгенерировать структурированный, вежливый и убедительный текст для КП.

Структура ответа должна быть такой:
1. Вежливое обращение.
2. Понимание задачи (кратко перефразируй, что нужно сделать).
3. Предлагаемое решение (что конкретно будет сделано, какие этапы).
4. Сроки и стоимость (используй заглушки, например, "[Сроки будут уточнены]" и "[Стоимость будет рассчитана]").
5. Призыв к действию (например, "Готов обсудить детали и ответить на ваши вопросы").

Стиль: Профессиональный, но дружелюбный.
"""

        response = client.chat.completions.create(
            model="gpt-3.5-turbo", # Начнем с быстрой и недорогой модели
            messages=[
                {"role": "system", "content": system_prompt},
                {"role": "user", "content": prompt}
            ]
        )
        
        return response.choices[0].message.content.strip()

    except Exception as e:
        # Улучшенное логирование ошибки
        print(f"!!! Произошла критическая ошибка при обращении к OpenAI: {e}")
        return f"Ошибка AI: Не удалось сгенерировать текст. Проверьте консоль, где запущен бот, для деталей."

if __name__ == '__main__':
    # Пример для тестирования модуля
    # Для этого теста нужно, чтобы в переменных окружения был OPENAI_API_KEY
    from dotenv import load_dotenv
    load_dotenv()
    
    # Проверка наличия ключа перед тестом
    if not os.getenv("OPENAI_API_KEY"):
        print("Ключ OPENAI_API_KEY не найден. Невозможно выполнить тест.")
    else:
        test_prompt = "Нужно сделать лендинг для кофейни. Стильный, современный, с картой."
        proposal = get_proposal_text(test_prompt)
        print("--- Сгенерированное предложение ---")
        print(proposal)
